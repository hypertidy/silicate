<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The fabric of hierarchical structures • silicate</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">silicate</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/topology.html">The fabric of hierarchical structures</a>
    </li>
    <li>
      <a href="../articles/translator.html">Format translator</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>The fabric of hierarchical structures</h1>
                        <h4 class="author">Michael Sumner</h4>
            
            <h4 class="date">9/27/2017</h4>
          </div>

    
    
<div class="contents">
<div id="silicate" class="section level2">
<h2 class="hasAnchor">
<a href="#silicate" class="anchor"></a>silicate</h2>
<p>The <code>silicate</code> package is a response to a fragmented landscape where many workarounds and re-implementations of similar patterns are often repeated.</p>
</div>
<div id="path" class="section level2">
<h2 class="hasAnchor">
<a href="#path" class="anchor"></a>PATH</h2>
<p>At the highest level silicate provides a normalized form of a complicated structure containing <em>paths</em>. This data structure contains three paths, each of which is a sequentially joined set of coordinates.</p>
<p>The key aspect here is that each component entity is formally named, with a unique ID that we persist for subsequent usage. This persistence is required as it records relationships between existing entitites <em>implicitly</em> rather than baking data into structure that are both <em>explicit</em> and also discard a lot of information about relationships.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(silicate)
x &lt;-<span class="st"> </span><span class="kw">PATH</span>(minimal_mesh)
<span class="kw">names</span>(x)</code></pre></div>
<pre><code>## [1] "object"           "path"             "path_link_vertex"
## [4] "vertex"</code></pre>
<p>At a basic level, the tables in this <code>PATH</code> are essentially the same as the kinds of structures we normally use, but we need to de-normalize them to see this exactly.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)</code></pre></div>
<pre><code>## 
## Attaching package: 'dplyr'</code></pre>
<pre><code>## The following objects are masked from 'package:stats':
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from 'package:base':
## 
##     intersect, setdiff, setequal, union</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">purrr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/reduce">reduce</a></span>(x[<span class="kw">c</span>(<span class="st">"object"</span>, <span class="st">"path"</span>, <span class="st">"path_link_vertex"</span>, <span class="st">"vertex"</span>)], dplyr<span class="op">::</span>inner_join) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(object,subobject, path_, x_, y_)</code></pre></div>
<pre><code>## Joining, by = "object_"</code></pre>
<pre><code>## Joining, by = "path_"</code></pre>
<pre><code>## Joining, by = "vertex_"</code></pre>
<pre><code>## # A tibble: 19 x 5
##    object subobject path_       x_    y_
##     &lt;int&gt;     &lt;int&gt; &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt;
##  1      1         1 d92f20d6 0     0    
##  2      1         1 d92f20d6 0     1.00 
##  3      1         1 d92f20d6 0.750 1.00 
##  4      1         1 d92f20d6 1.00  0.800
##  5      1         1 d92f20d6 0.500 0.700
##  6      1         1 d92f20d6 0.800 0.600
##  7      1         1 d92f20d6 0.690 0    
##  8      1         1 d92f20d6 0     0    
##  9      1         1 b64ced0c 0.200 0.200
## 10      1         1 b64ced0c 0.500 0.200
## 11      1         1 b64ced0c 0.500 0.400
## 12      1         1 b64ced0c 0.300 0.600
## 13      1         1 b64ced0c 0.200 0.400
## 14      1         1 b64ced0c 0.200 0.200
## 15      2         1 46e0e494 0.690 0    
## 16      2         1 46e0e494 0.800 0.600
## 17      2         1 46e0e494 1.10  0.630
## 18      2         1 46e0e494 1.23  0.300
## 19      2         1 46e0e494 0.690 0</code></pre>
</div>
<div id="edge" class="section level2">
<h2 class="hasAnchor">
<a href="#edge" class="anchor"></a>EDGE</h2>
<p>Paths are easily re-expressed as a set of edges, treating each pair of coordinates as a new kind of entity. Some edges are <em>shared</em>, in that two objects might have a particular edge in their own path. If the shared neighbours are two polygons, then it’s likely that each polygon encounters that edge in a different direction, but this is not a stable pattern so it’s best to not assume it to be the case. It’s important here because we need to differentiate between an <em>instance of an edge</em>, which is a particular <em>line segment</em> that is part of one particular polygon. If that polygon segment is a shared edge with a neighbour polygon, then we distinguish the instances as a particular <em>segment</em> of a unique <em>edge</em>. This allows us the opportunity to treat the edge as completely abstract, and also to decide or record what it’s orientation is, which records which vertex is the first one, and which is the second. Not all applications need to care about this distinction, though.</p>
<p>In this way we have an analogy for edges and segments compared to vertices and coordinates, and I think this terminology makes sense but I’m open to discussion(!).</p>
<p>Some temporary internal functions (with “_base" appended) here are used to find the unique edges, and then identify what vertices are <em>nodes</em> when treating a structure as a connected mesh. Nodes are any coordinate where three or more edges meet each other, so they are inherently about relationships between neighbouring shapes. This is exactly the same model as was used in the olden days, called arc-node topology, a one-dimensional topology that pre-dates the more modern use of closed planar paths to describe polygons.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)
unique_edges &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span>(silicate<span class="op">:::</span><span class="kw">sc_segment_base</span>(x<span class="op">$</span>path_link_vertex), edge_, <span class="dt">.keep_all =</span> <span class="ot">TRUE</span>)
vertex &lt;-<span class="st"> </span>x<span class="op">$</span>vertex
nodes &lt;-<span class="st"> </span>silicate<span class="op">:::</span><span class="kw">sc_node_base</span>(unique_edges, vertex)
<span class="kw">library</span>(sf); <span class="kw"><a href="http://www.rdocumentation.org/packages/sf/topics/plot">plot</a></span>(minimal_mesh<span class="op">$</span>geom)</code></pre></div>
<pre><code>## Linking to GEOS 3.6.2, GDAL 2.2.3, proj.4 4.9.3</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="http://dplyr.tidyverse.org/reference/join.html">inner_join</a></span>(nodes, x<span class="op">$</span>vertex) <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(x_, y_) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">points</span>()</code></pre></div>
<pre><code>## Joining, by = "vertex_"</code></pre>
<p><img src="topology_files/figure-html/unnamed-chunk-3-1.png" width="672"> There’s only one more entity we need, and this is the actual component paths that describe these structures topologically. These are paths that occur between any two nodes, or that have no nodes at all. This will occur for any isolated “island”, or for any hole within a polygon. These arcs are exactly analogous to a LINESTRING, but are used within a context where the nodes are important information about the topology.</p>
<p>Currently we haven’t yet normalized the arcs …</p>
<p>or made this work yet …</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">arcs &lt;-<span class="st"> </span>silicate<span class="op">:::</span><span class="kw">sc_arc_base</span>(x<span class="op">$</span>path_link_vertex, nodes) 
<span class="kw"><a href="http://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span>(arcs, arc)


sarcs &lt;-<span class="st"> </span><span class="kw">split</span>(arcs, arcs<span class="op">$</span>arc_)
<span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_along</span>(sarcs)) {
  <span class="kw"><a href="http://www.rdocumentation.org/packages/sf/topics/plot">plot</a></span>(sf<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/sf/topics/st_cast">st_cast</a></span>(minimal_mesh, <span class="st">"MULTILINESTRING"</span>), <span class="dt">col =</span> <span class="st">"black"</span>)
  <span class="kw">lines</span>(sarcs[[i]] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/join.html">inner_join</a></span>(x<span class="op">$</span>vertex) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(x_, y_), <span class="dt">col =</span> <span class="st">"firebrick"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)
}</code></pre></div>
<p>We haven’t yet done any coordinate precision checking, so there will be mis-identified arcs where coordinates are intended to be but are not exactly the same. (spdep glosses over this in a way we can’t control)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)
<span class="kw">library</span>(sf)
col1 &lt;-<span class="st"> </span>polymesh
<span class="co">#example(st_read)</span>
x &lt;-<span class="st"> </span><span class="kw">PATH</span>(polymesh)

unique_edges &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span>(silicate<span class="op">:::</span><span class="kw">sc_segment_base</span>(x<span class="op">$</span>path_link_vertex), edge, <span class="dt">.keep_all =</span> <span class="ot">TRUE</span>)
vertex &lt;-<span class="st"> </span>x<span class="op">$</span>vertex
nodes &lt;-<span class="st"> </span>silicate<span class="op">:::</span><span class="kw">sc_node_base</span>(unique_edges, vertex)

arcs &lt;-<span class="st"> </span>silicate<span class="op">:::</span><span class="kw">sc_arc_base</span>(x<span class="op">$</span>path_link_vertex, nodes) 
<span class="kw"><a href="http://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span>(arcs, arc)



sarcs &lt;-<span class="st"> </span><span class="kw">split</span>(arcs, arcs<span class="op">$</span>arc_)
sf_arcs &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/sf/topics/sf">st_sf</a></span>(<span class="dt">arc =</span> <span class="kw">seq_along</span>(sarcs), <span class="kw"><a href="http://www.rdocumentation.org/packages/sf/topics/sfc">st_sfc</a></span>(<span class="kw">lapply</span>(sarcs, <span class="cf">function</span>(a) {
  <span class="kw"><a href="http://www.rdocumentation.org/packages/sf/topics/st">st_linestring</a></span>(<span class="kw"><a href="http://dplyr.tidyverse.org/reference/join.html">inner_join</a></span>(a, x<span class="op">$</span>vertex, <span class="st">"vertex_"</span>) <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(x_, y_) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.matrix</span>())
})))

<span class="kw"><a href="http://www.rdocumentation.org/packages/sf/topics/plot">plot</a></span>(sf_arcs)
<span class="co"># for (i in seq_along(sarcs)) {</span>
<span class="co">#   plot(sf::st_cast(st_geometry(col1), "MULTILINESTRING"), col = "black")</span>
<span class="co">#   lines(sarcs[[i]] %&gt;% inner_join(x$vertex) %&gt;% dplyr::select(x_, y_), col = "firebrick", lwd = 2)</span>
<span class="co"># }</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#silicate">silicate</a></li>
      <li><a href="#path">PATH</a></li>
      <li><a href="#edge">EDGE</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Michael D. Sumner, Mark Padgham.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
